name: Check Updates

on:
  schedule:
    - cron: '45 07 * * 1-5'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-version:
    runs-on: ubuntu-latest

    permissions:
      contents: write # Required for creating branches and PRs
      pull-requests: write # Required for creating PRs

    steps:
    - name: Checkout repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0 # Fetch all history
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        pip install requests==2.32.5

    - name: Get OpenAPI version and check for existing PRs
      id: version_check
      run: |
        python << 'EOF'
        import requests
        import json
        import subprocess
        import sys
        import os

        def get_openapi_version():
            """Get version from OpenAPI spec"""
            try:
                response = requests.get('https://api.reveng.ai/openapi.json', timeout=30)
                response.raise_for_status()
                openapi_data = response.json()
                return openapi_data.get('info', {}).get('version')
            except Exception as e:
                print(f"Error fetching OpenAPI spec: {e}")
                return None

        def check_existing_prs():
            """Check if there are existing open PRs from the bot"""
            try:
                result = subprocess.run([
                    'gh', 'pr', 'list', '--state', 'open',
                    '--author', 'app/github-actions', '--json', 'title'
                ], capture_output=True, text=True, check=True)

                prs = json.loads(result.stdout)
                for pr in prs:
                    if 'SDK update' in pr.get('title', '') or 'OpenAPI' in pr.get('title', ''):
                        return True
                return False
            except Exception as e:
                print(f"Error checking existing PRs: {e}")
                return True  # Assume PR exists to be safe

        # Main logic
        print("ðŸ” Getting OpenAPI version and checking for existing PRs...")

        # Get OpenAPI version
        openapi_version = get_openapi_version()

        if not openapi_version:
            print("âŒ Could not retrieve OpenAPI version")
            sys.exit(1)

        print(f"ðŸ“‹ OpenAPI version: {openapi_version}")

        # Create NPM-compatible version (remove 'v' prefix if it exists)
        openapi_version_npm = openapi_version.lstrip('v')
        print(f"ðŸ“‹ NPM version: {openapi_version_npm}")

        # Check for existing PRs
        if check_existing_prs():
            print("ðŸ“‹ Existing PR found, skipping SDK generation")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"should_generate=false\n")
        else:
            print("âœ… No existing PRs found, proceeding with SDK generation")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"should_generate=true\n")
                f.write(f"openapi_version={openapi_version}\n")
                f.write(f"openapi_version_npm={openapi_version_npm}\n")

        print("âœ… Check completed")
        EOF
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate TypeScript SDK
      if: steps.version_check.outputs.should_generate == 'true'
      uses: openapi-generators/openapitools-generator-action@b729d184e6b3459572c37c0e37f88a832e69b552 # v1.5.0
      with:
        generator: typescript
        generator-tag: 'v7.17.0'
        openapi-url: https://api.reveng.ai/openapi.json
        config-file: config.yml
        template-dir: templates
        # For the artifact version drop the `v` prefix as it's not usually used in NPM versions
        command-args: >
          --additional-properties=artifactVersion=${{ steps.version_check.outputs.openapi_version_npm }}

    - name: Check for changes
      if: steps.version_check.outputs.should_generate == 'true'
      id: check_changes
      env:
        OPENAPI_VERSION: ${{ steps.version_check.outputs.openapi_version }}
      run: |
        # Move generated files to the correct locations and clean up
        rm -Rf apis && mv typescript-client/apis .
        rm -Rf auth && mv typescript-client/auth .
        rm -Rf docs && mv typescript-client/docs .
        rm -Rf http && mv typescript-client/http .
        rm -Rf models && mv typescript-client/models .
        rm -Rf types && mv typescript-client/types .
        rm -Rf *.ts && mv typescript-client/*.ts .
        rm -Rf package.* && mv typescript-client/package.* .
        rm -Rf tsconfig.json && mv typescript-client/tsconfig.json .
        rm -Rf README.md && mv typescript-client/README.md .
        rm -Rf typescript-client

        # Store the SDK version
        echo "$OPENAPI_VERSION" > .sdk-version

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if there are any changes
        if git diff --quiet && git diff --cached --quiet; then
          echo "No changes detected in generated SDK"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected in generated SDK"
          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Show what changed
          echo "Files changed:"
          git diff --name-only
          echo
          echo "Summary of changes:"
          git diff --stat
        fi

    - name: Generate a token
      if: steps.version_check.outputs.should_generate == 'true' && steps.check_changes.outputs.has_changes == 'true'
      id: generate-token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      with:
        app-id: ${{ secrets.REVENG_APP_ID }}
        private-key: ${{ secrets.REVENG_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}
        repositories: |
          sdk-typescript

    - name: Create Pull Request
      if: steps.version_check.outputs.should_generate == 'true' && steps.check_changes.outputs.has_changes == 'true'
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        OPENAPI_VERSION: ${{ steps.version_check.outputs.openapi_version }}
      run: |
        # Create a new branch
        BRANCH_NAME="sdk-update-${OPENAPI_VERSION}"
        git checkout -b "$BRANCH_NAME"

        # Stage all changes
        git add .

        # Commit changes
        git commit -m "Update SDK to version ${OPENAPI_VERSION}

        - Generated from OpenAPI spec version ${OPENAPI_VERSION}
        - Auto-generated by GitHub Actions"

        # Push the branch
        git push -f origin "$BRANCH_NAME"

        # Create PR using GitHub CLI
        gh pr create \
          --title "ðŸ¤– Update SDK to version ${OPENAPI_VERSION}" \
          --body "## ðŸ”„ Automated SDK Update

        This PR was automatically generated to update the TypeScript SDK to match the latest OpenAPI specification.

        ### ðŸ“Š Version Information
        - **OpenAPI Spec Version**: \`${OPENAPI_VERSION}\`

        ### ðŸ”§ Changes
        - Generated fresh SDK from [OpenAPI specification](https://api.reveng.ai/openapi.json)
        - Updated package version to match OpenAPI spec version
        - All changes are auto-generated using openapi-generator

        ### âœ… Next Steps
        1. Review the generated changes
        2. Run tests to ensure compatibility
        3. Merge to trigger automatic NPM publishing

        ---
        ðŸ¤– *This PR was created automatically by GitHub Actions*" \
          --head "$BRANCH_NAME" \
          --base main

        echo "âœ… Pull request created successfully"
        echo "::notice title=PR Created::Created PR for SDK update to version ${OPENAPI_VERSION}"
